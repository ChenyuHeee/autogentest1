这是一个针对 **`ChenyuHeee/autogentest1` 行情数据源稳定性优化** 的技术提案。

该提案旨在解决由于 `yfinance` 接口限流导致的“数据获取空值”及下游“风控模块计算失败”的阻断性问题。

---

# 技术提案：行情数据获取层的高可用性改造方案

## 1. 问题陈述 (Problem Statement)
当前系统在 `Phase 1` (数据收集) 或 `Phase 4` (风控计算) 阶段调用 `fetch_price_history` 工具时，由于短时间内对 Yahoo Finance 非官方接口的高频访问，频繁触发服务端的 IP 限流（Rate Limiting）。
**后果**：
1.  API 返回空 DataFrame。
2.  下游 `RiskManagerAgent` 无法计算 VaR（风险价值）和 Drawdown（回撤）。
3.  系统抛出异常或发出“无法计算”告警，导致整个交易晨会流程中断（Blocker）。

## 2. 根本原因分析 (Root Cause Analysis)
*   **无状态请求**：每次工具调用都是全新的 HTTP 请求，未利用本地缓存。在多智能体对话中，不同 Agent 可能重复请求同一标的数据。
*   **缺乏重试机制**：网络抖动或临时限流（HTTP 429）发生时，系统直接放弃而不是按策略退避重试。
*   **强依赖外部服务**：开发/测试环境与生产环境未隔离，调试逻辑时也必须请求真实网络，增加了被封禁概率。

## 3. 解决方案架构 (Proposed Solution)

本提案建议采用 **三级防御策略** 来确保数据层的健壮性：

1.  **L1: 本地持久化缓存 (Local Caching)** —— 消除重复请求。
2.  **L2: 指数退避重试 (Exponential Backoff)** —— 对抗网络波动。
3.  **L3: 开发模式 Mock (Mock Mode)** —— 彻底解耦逻辑开发与数据获取。

---

## 4. 实施细节 (Implementation Details)

### 4.1. 引入 `requests-cache` 实现会话级缓存
利用 SQLite 本地文件缓存请求结果。如果在 `expire_after` 时间内（如 10 分钟）再次请求相同 URL，直接从磁盘读取，**网络请求数降为 0**。

*   **新增依赖**: `pip install requests-cache`
*   **代码变更 (`autogentest1/tools/data_tools.py`)**:

```python
import yfinance as yf
import requests_cache
from datetime import timedelta

# 初始化缓存 session
# backend='sqlite' 会在根目录生成 yfinance_cache.sqlite
# expire_after=timedelta(minutes=10) 设定缓存有效期为10分钟
session = requests_cache.CachedSession(
    'yfinance_cache', 
    backend='sqlite', 
    expire_after=timedelta(minutes=10)
)

# 将 session 注入到 yfinance
# 注意：yfinance 允许通过 .Ticker(..., session=session) 传递
```

### 4.2. 增加指数退避重试 (Retry Strategy)
当缓存失效且发生真实请求，如果遇到 429 (Too Many Requests) 错误，不应立即报错，而应等待后重试。

```python
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

# 配置重试策略
retry_strategy = Retry(
    total=5,  # 最大重试次数
    backoff_factor=1,  # 等待时间因子: 1s, 2s, 4s, 8s, 16s
    status_forcelist=[429, 500, 502, 503, 504], # 针对这些状态码重试
    allowed_methods=["HEAD", "GET", "OPTIONS"]
)
adapter = HTTPAdapter(max_retries=retry_strategy)

# 将重试适配器挂载到 session
session.mount("https://", adapter)
session.mount("http://", adapter)

def fetch_price_history_robust(symbol: str, period: str = "1mo"):
    try:
        # 传递带有 缓存+重试 功能的 session
        ticker = yf.Ticker(symbol, session=session)
        df = ticker.history(period=period)
        
        # 二次校验：Yahoo 有时返回空表但不报错
        if df.empty:
            raise ValueError(f"Empty data returned for {symbol}")
            
        return df
    except Exception as e:
        print(f"[DataError] Failed to fetch {symbol}: {str(e)}")
        # 返回 None 或抛出异常，由 Agent 处理
        raise e 
```

### 4.3. 实现 Mock 数据开关 (开发环境专用)
在开发 Agent 的提示词（Prompt）或逻辑时，无需真实数据。

*   **配置变更**: 在 `.env` 文件中增加 `DATA_MODE=MOCK`。
*   **准备数据**: 在项目根目录放置 `data/XAUUSD_MOCK.csv`。
*   **逻辑变更**:

```python
import os
import pandas as pd

def get_market_data(symbol):
    if os.getenv("DATA_MODE") == "MOCK":
        print(f"⚠️ USING MOCK DATA FOR {symbol}")
        # 确保 CSV 格式与 yfinance 返回格式一致
        return pd.read_csv(f"data/{symbol}_MOCK.csv", index_col=0, parse_dates=True)
    
    return fetch_price_history_robust(symbol)
```

---

## 5. 风险评估与缓解 (Risk Assessment)

| 潜在风险 | 影响等级 | 缓解措施 |
| :--- | :--- | :--- |
| **缓存数据过期** | 中 | 在实盘交易时段（如美盘开盘），应缩短缓存时间（如 1 分钟）或在关键操作前手动清除缓存。 |
| **Mock 数据导致策略偏差** | 低 | 明确区分 `.env` 配置，生产环境强制 `DATA_MODE=LIVE`。 |
| **SQLite 并发锁** | 低 | `requests-cache` 的 SQLite 后端在多线程下通常是安全的，但在极端高并发下可能需切换到 Redis 后端（当前项目规模暂不需要）。 |

## 6. 验收标准 (Acceptance Criteria)

1.  **稳定性**: 在断开网络连接的情况下（前提是缓存已预热），运行 `python -m autogentest1.main` 不报错，且能完成所有晨会流程。
2.  **健壮性**: 模拟 HTTP 429 错误（可通过 Mock 适配器模拟），系统应在日志中显示 "Retrying..." 并最终成功或优雅降级。
3.  **风控模块**: `RiskManagerAgent` 不再收到空数据，能够输出具体的 VaR 数值。

## 7. 下一步建议
本提案实施后，短期内解决了稳定性问题。长期来看，建议申请 **Alpha Vantage** 或 **Tiingo** 的免费 API Key 作为 `yfinance` 的备用（Fallback）数据源，构建双活数据层。