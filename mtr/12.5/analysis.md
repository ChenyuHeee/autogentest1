# AutoGen é»„é‡‘äº¤æ˜“ç³»ç»Ÿç¡¬é£æ§è®¾ç½®ä¸“ä¸šåˆ†ææŠ¥å‘Š

**åˆ†æå¸ˆèµ„è´¨èƒŒæ™¯**ï¼šå››åå¹´é»„é‡‘äº¤æ˜“ä¸ç²¾ç®—ç»éªŒï¼Œæ¶‰çŒåœºå†…æœŸè´§ã€OTCç°è´§ã€ETFå¥—åˆ©ç­‰å¤šç§é»„é‡‘äº¤æ˜“å“ç§ï¼Œæ›¾ä»»èŒäºæ¬§ç¾å¤§å‹å¯¹å†²åŸºé‡‘é£æ§éƒ¨é—¨ã€‚

**æ—¥æœŸ**ï¼š2025å¹´12æœˆ5æ—¥  
**é¡¹ç›®ç‰ˆæœ¬**ï¼šautogentest1 (commit c5fe7d6)

---

## æ‰§è¡Œæ‘˜è¦ï¼ˆExecutive Summaryï¼‰

ç»è¿‡å¯¹è´µé¡¹ç›®å®Œæ•´ä»£ç åº“çš„ç»†è‡´å®¡é˜…ï¼Œæˆ‘å¯¹é£æ§ç³»ç»Ÿçš„ä¸“ä¸šè¯„ä¼°å¦‚ä¸‹ï¼š

### âœ… ä¼˜ç‚¹
1. **å¤šå±‚é£æ§æ¶æ„æ¸…æ™°**ï¼šè½¯é£æ§ï¼ˆåˆè§„å±‚ï¼‰â†’ ç¡¬é£æ§é—¸é—¨ â†’ å¼‚å¸¸æ‹¦æˆªï¼Œå±‚æ¬¡åˆ†æ˜
2. **æ­¢æŸè¦†ç›–ç‡æœºåˆ¶å…ˆè¿›**ï¼šæŒ‰å“ç§å’Œæ–¹å‘åˆ†åˆ«è¿½è¸ªï¼Œä¼˜äºè¡Œä¸šå¹³å‡æ°´å¹³
3. **æµåŠ¨æ€§è¯„ä¼°å…¨é¢**ï¼šåŒæ—¶è€ƒè™‘æˆäº¤é‡ã€ä»·å·®ã€ATRæ»‘ç‚¹ï¼Œç¬¦åˆæœºæ„æ ‡å‡†
4. **åœºæ™¯å‹åŠ›æµ‹è¯•é›†æˆ**ï¼šå°† VaR ä¸æƒ…æ™¯åˆ†æç»“åˆï¼Œä½“ç°é‡åŒ–é£æ§æ€ç»´

### âš ï¸ æ ¸å¿ƒé£é™©ç‚¹
1. **æ­¢æŸè·ç¦»èŒƒå›´è¿‡äºä¿å®ˆ**ï¼š0.1%-3% ä¸é€‚åˆé»„é‡‘æ³¢åŠ¨ç‰¹æ€§ï¼ˆé»„é‡‘æ—¥æ³¢åŠ¨å¸¸è¶…è¿‡1%ï¼‰
2. **æµåŠ¨æ€§é˜ˆå€¼è¿‡äºä¸¥æ ¼**ï¼šæ»‘ç‚¹ 35bpsã€ä»·å·® 25bps å°†åœ¨éç¾äº¤æ˜“æ—¶æ®µé¢‘ç¹è§¦å‘
3. **å•ç¬”è®¢å•é™åˆ¶ç¼ºå¤±ç¡¬é…ç½®**ï¼šä¾èµ– `compliance_max_single_order_oz`ï¼Œæ— ç‹¬ç«‹ç¡¬é™
4. **ç›¸å…³æ€§é˜ˆå€¼ 0.9 è¿‡é«˜**ï¼šé»„é‡‘ä¸ç¾å…ƒæŒ‡æ•°ç›¸å…³æ€§å¸¸æ€åŒ–è¶…è¿‡æ­¤å€¼ï¼Œå½¢åŒè™šè®¾
5. **æ•°æ®æºè´¨é‡ä¸è¶³ä»¥æ”¯æ’‘ç¡¬é£æ§å†³ç­–**ï¼šyfinance ç­‰å…è´¹æ•°æ®å­˜åœ¨å»¶è¿Ÿå’Œç²¾åº¦é—®é¢˜

### ğŸ“Š ç›ˆåˆ©å¯è¡Œæ€§è¯„ä¼°
- **å½“å‰é…ç½®ä¸‹å…¨è‡ªåŠ¨äº¤æ˜“**ï¼šä¸å¯è¡Œï¼Œè§¦å‘å‡è­¦æŠ¥é¢‘ç‡è¿‡é«˜ï¼Œé”™å¤±äº¤æ˜“æœºä¼š
- **ä½œä¸ºè¾…åŠ©å†³ç­–ç³»ç»Ÿ**ï¼šå¯è¡Œï¼Œéœ€è°ƒæ•´å‚æ•°å¹¶ä¿ç•™äººå·¥æœ€ç»ˆç¡®è®¤
- **ä¼˜åŒ–åæ³¢æ®µäº¤æ˜“**ï¼šæœ‰æ½œåŠ›ï¼Œéœ€é…åˆæ•°æ®æºå‡çº§ä¸å‚æ•°é‡æ ¡

---

## ä¸€ã€ç¡¬é£æ§å‚æ•°è¯¦ç»†åˆ†æ

### 1.1 æ­¢æŸè·ç¦»æ§åˆ¶ï¼ˆStop Distance Controlï¼‰

#### å½“å‰é…ç½®
```python
hard_gate_min_stop_distance_pct: float = 0.1   # 0.1%
hard_gate_max_stop_distance_pct: float = 3.0   # 3.0%
```

#### ä¸“ä¸šè¯„ä¼°

**âŒ åˆ¤å®šï¼šä¸åˆç†ï¼Œè¿‡äºä¿å®ˆ**

**ç†ç”±**ï¼š
1. **é»„é‡‘æ³¢åŠ¨ç‰¹æ€§**ï¼š
   - XAUUSD å†å²æ—¥å‡æ³¢åŠ¨ç‡ï¼ˆATR%ï¼‰çº¦ä¸º 0.8%-1.5%
   - éå†œæ•°æ®å…¬å¸ƒæ—¥å¯è¾¾ 2%-4%
   - åœ°ç¼˜äº‹ä»¶ï¼ˆå¦‚ä¸­ä¸œå†²çªï¼‰å•æ—¥æ³¢å¹…å¯è¶…è¿‡ 5%

2. **æœ€å°æ­¢æŸ 0.1% çš„é—®é¢˜**ï¼š
   - å¯¹åº”é»„é‡‘ä»·æ ¼ 2600 ç¾å…ƒæ—¶ï¼Œæ­¢æŸè·ç¦»ä»… **2.6 ç¾å…ƒ**
   - æ­£å¸¸ç›˜ä¸­å™ªéŸ³ï¼ˆBid-Ask bounceï¼‰å³å¯è§¦å‘æ­¢æŸ
   - ç›¸å½“äº"è¢«èšŠå­å’¬ä¸€å£å°±ç ä»“"ï¼Œå°†å¯¼è‡´é¢‘ç¹å‡è§¦å‘

3. **æœ€å¤§æ­¢æŸ 3% çš„é—®é¢˜**ï¼š
   - å¯¹äºæ³¢æ®µäº¤æ˜“ï¼ˆæŒä»“æ•°æ—¥ï¼‰ï¼Œ3% åœ¨å¤§æ³¢åŠ¨æœŸé—´å¯èƒ½ä¸è¶³
   - å¯¹æ¯”ï¼šä¼ ç»Ÿè´µé‡‘å±äº¤æ˜“å°æ­¢æŸé€šå¸¸è®¾ç½®åœ¨ **å…³é”®æŠ€æœ¯ä½**ï¼Œè€Œéå›ºå®šç™¾åˆ†æ¯”
   - 2600 ç¾å…ƒé»„é‡‘ï¼Œ3% æ­¢æŸè·ç¦»ä¸º 78 ç¾å…ƒï¼Œåœ¨è¶‹åŠ¿äº¤æ˜“ä¸­å¯èƒ½è¿‡æ—©ç¦»åœº

#### å»ºè®®ä¿®æ”¹

```python
# å»ºè®®é…ç½®ï¼ˆåˆ†åœºæ™¯ï¼‰
# æ—¥å†…äº¤æ˜“ï¼ˆIntradayï¼‰
hard_gate_min_stop_distance_pct: float = 0.3   # æå‡è‡³ 0.3%
hard_gate_max_stop_distance_pct: float = 1.5   # é€‚åˆæ—¥å†…

# æ³¢æ®µäº¤æ˜“ï¼ˆSwing Tradingï¼Œæ¨èï¼‰
hard_gate_min_stop_distance_pct: float = 0.5   # 0.5%
hard_gate_max_stop_distance_pct: float = 5.0   # 5%

# è¶‹åŠ¿äº¤æ˜“ï¼ˆPosition Tradingï¼‰
hard_gate_min_stop_distance_pct: float = 1.0   # 1%
hard_gate_max_stop_distance_pct: float = 8.0   # 8%
```

**é‡è¦**ï¼šæ­¢æŸåº”åŸºäº **æŠ€æœ¯æ”¯æ’‘é˜»åŠ›ä½** è€ŒéåƒµåŒ–ç™¾åˆ†æ¯”ã€‚å»ºè®®å¢åŠ ä»¥ä¸‹é€»è¾‘ï¼š
```python
# ä¼ªä»£ç 
if stop_set_by_technical_level:  # å¦‚åŸºäº 20 æ—¥å‡çº¿
    skip_percentage_check()
else:
    enforce_percentage_limits()
```

---

### 1.2 æ­¢æŸè¦†ç›–ç‡ï¼ˆStop Coverage Ratioï¼‰

#### å½“å‰é…ç½®
```python
hard_gate_stop_coverage_ratio: float = 1.0  # 100% è¦†ç›–
```

#### ä¸“ä¸šè¯„ä¼°

**âœ… åˆ¤å®šï¼šåˆç†ï¼Œç¬¦åˆæœºæ„æ ‡å‡†**

**ä¼˜ç‚¹**ï¼š
- å¼ºåˆ¶è¦æ±‚æ¯ 1 ç›å¸å¤šå¤´å¤´å¯¸éƒ½å¿…é¡»æœ‰ 1 ç›å¸çš„æ­¢æŸå•ä¿æŠ¤
- ä»£ç æ­£ç¡®åŒºåˆ†äº†ä¸»æ–¹å‘æ•å£ï¼ˆPrimary Directionï¼‰ä¸å¯¹å†²/å¹³ä»“è®¢å•ï¼Œé¿å…é‡å¤è®¡ç®—
- æŒ‰å“ç§å’Œæ–¹å‘åˆ†åˆ«ç»Ÿè®¡ï¼ˆ`exposure` å’Œ `coverage` åˆ† `(instrument, side)` keyï¼‰ï¼Œä¸¥è°¨

**æ½œåœ¨é—®é¢˜**ï¼š
- **å¯¹å¥—åˆ©ç­–ç•¥ä¸å‹å¥½**ï¼šä¾‹å¦‚é‡‘é“¶æ¯”å¥—åˆ©ï¼ˆLong Gold + Short Silverï¼‰ï¼Œç³»ç»Ÿå¯èƒ½è¯¯åˆ¤ä¸ºä¸¤ä¸ªç‹¬ç«‹å¤´å¯¸ï¼Œè¦æ±‚åŒå‘æ­¢æŸï¼Œå®é™…ä¸Šç»„åˆæœ¬èº«å·²å¯¹å†²
- **åŠ¨æ€å¯¹å†²åœºæ™¯**ï¼šæœºæ„äº¤æ˜“å°å¸¸ç”¨æœŸæƒå¯¹å†²ç°è´§ï¼ŒæœŸæƒ Delta ä¼šåŠ¨æ€å˜åŒ–ï¼Œå›ºå®š 100% è¦†ç›–å¯èƒ½è¿‡ä¸¥

#### å»ºè®®ä¿ç•™ä¸ä¾‹å¤–

```python
# ä¿æŒ 1.0 ä½œä¸ºé»˜è®¤å€¼ï¼Œä½†å…è®¸ç‰¹å®šç­–ç•¥è±å…
hard_gate_stop_coverage_ratio: float = 1.0  

# å¢åŠ ä¾‹å¤–ç™½åå•ï¼ˆæ–°å¢é…ç½®ï¼‰
hard_gate_stop_coverage_exemptions: List[str] = [
    "SPREAD_TRADE",  # è·¨æœŸå¥—åˆ©
    "PAIR_TRADE",    # é‡‘é“¶æ¯”å¯¹
    "DELTA_NEUTRAL"  # Delta ä¸­æ€§ç­–ç•¥
]
```

---

### 1.3 æµåŠ¨æ€§é—¨æ§›ï¼ˆLiquidity Thresholdsï¼‰

#### å½“å‰é…ç½®
```python
hard_gate_min_liquidity_depth_oz: float | None = 1500.0    # 1500 ç›å¸
hard_gate_max_spread_bps: float = 25.0                     # 25 åŸºç‚¹
hard_gate_max_slippage_bps: float = 35.0                   # 35 åŸºç‚¹
hard_gate_depth_buffer_ratio: float = 1.2                  # 120% ç¼“å†²
```

#### ä¸“ä¸šè¯„ä¼°

**âš ï¸ åˆ¤å®šï¼šéƒ¨åˆ†åˆç†ï¼Œä½†é˜ˆå€¼è®¾å®šè¿‡ä¸¥**

**åˆ†æ**ï¼š

##### 1.3.1 æœ€å°æ·±åº¦ 1500 ç›å¸
- **åˆç†æ€§**ï¼šXAUUSD ç°è´§å¸‚åœºï¼Œé¡¶çº§æµåŠ¨æ€§æä¾›å•†ï¼ˆLBMAï¼‰ç›˜å£æ·±åº¦é€šå¸¸åœ¨ 5000-10000 ç›å¸
- **é—®é¢˜**ï¼š
  - å¯¹äº **ä¸­å°è§„æ¨¡äº¤æ˜“è€…**ï¼ˆå•ç¬” 500-1000 ç›å¸ï¼‰ï¼Œ1500 è¦æ±‚åé«˜
  - ä½ çš„ `MAX_POSITION_OZ=5000`ï¼Œå•ç¬” 1500 æ„å‘³ç€æœ€å¤šæ‹† 3-4 ç¬”ï¼Œçµæ´»æ€§ä¸è¶³
  - **äºšæ´²äº¤æ˜“æ—¶æ®µ**ï¼ˆåŒ—äº¬æ—¶é—´ 8:00-16:00ï¼‰æµåŠ¨æ€§æ˜¾è‘—ä½äºä¼¦æ•¦/çº½çº¦æ—¶æ®µï¼Œå®¹æ˜“è¯¯è§¦å‘

- **å»ºè®®**ï¼š
```python
hard_gate_min_liquidity_depth_oz: float = 800.0  # é™ä½è‡³ 800
# æˆ–æ ¹æ®è®¢å•å¤§å°åŠ¨æ€è°ƒæ•´
min_depth = max(800, order_size * 0.8)
```

##### 1.3.2 ä»·å·®ä¸Šé™ 25 åŸºç‚¹
- **ç°å®æ•°æ®**ï¼š
  - XAUUSD æ¬§ç¾æ—¶æ®µå…¸å‹ä»·å·®ï¼š**5-15 åŸºç‚¹**ï¼ˆ0.5-1.5 ç¾å…ƒï¼‰
  - äºšæ´²æ—¶æ®µï¼š**15-30 åŸºç‚¹**
  - é‡å¤§æ–°é—»æœŸé—´ï¼š**50-100 åŸºç‚¹**
  
- **é—®é¢˜**ï¼š25 åŸºç‚¹ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè¯¯è§¦å‘ï¼š
  - äºšæ´²æ—©ç›˜ï¼ˆæµåŠ¨æ€§è‡ªç„¶è¾ƒä½ï¼‰
  - å‘¨æœ«è·³ç©ºå¼€ç›˜
  - å°å‹ç»çºªå•†æ•°æ®æºï¼ˆéé¡¶çº§é“¶è¡ŒæŠ¥ä»·ï¼‰

- **å»ºè®®**ï¼š
```python
hard_gate_max_spread_bps: float = 40.0  # æå‡è‡³ 40 åŸºç‚¹
# æˆ–åˆ†æ—¶æ®µé…ç½®
max_spread = 25.0 if is_london_newyork_session() else 50.0
```

##### 1.3.3 æ»‘ç‚¹ä¸Šé™ 35 åŸºç‚¹
- **è®¡ç®—é€»è¾‘å®¡æŸ¥**ï¼š
```python
# risk_gate.py Line 424
if atr_slippage_bps is not None:
    scale = max(1.0, dominant_exposure / settings.hard_gate_liquidity_baseline_oz)
    estimated_slippage_bps = atr_slippage_bps * scale
```

- **ä¼˜ç‚¹**ï¼šæŒ‰è®¢å•å¤§å°åŠ¨æ€ç¼©æ”¾ï¼Œç§‘å­¦
- **é—®é¢˜**ï¼š
  - `liquidity_baseline_oz = 1000` ä½œä¸ºåŸºå‡†åä½ï¼ˆæœºæ„æ ‡å‡†é€šå¸¸ 5000-10000ï¼‰
  - å¯¼è‡´ç¨å¤§è®¢å•å°±è§¦å‘æ»‘ç‚¹è­¦æŠ¥
  - ATR æœ¬èº«å·²æ˜¯æ³¢åŠ¨ç‡æŒ‡æ ‡ï¼Œå†ä¹˜ä»¥è§„æ¨¡ä¼šåŒé‡æƒ©ç½š

- **å»ºè®®**ï¼š
```python
hard_gate_liquidity_baseline_oz: float = 3000.0  # æå‡è‡³ 3000
hard_gate_max_slippage_bps: float = 50.0         # æå‡è‡³ 50 åŸºç‚¹

# æ»‘ç‚¹å…¬å¼è°ƒæ•´
estimated_slippage = atr_slippage_bps * sqrt(dominant_exposure / baseline_oz)
# ä½¿ç”¨å¹³æ–¹æ ¹è€Œéçº¿æ€§ï¼Œæ›´ç¬¦åˆå¸‚åœºå†²å‡»æ¨¡å‹ï¼ˆKyle's Lambdaï¼‰
```

---

### 1.4 å¤´å¯¸åˆ©ç”¨ç‡ï¼ˆPosition Utilizationï¼‰

#### å½“å‰é…ç½®
```python
hard_gate_max_position_utilization: float | None = 1.0  # 100%
MAX_POSITION_OZ = 5000  # .env é…ç½®
```

#### ä¸“ä¸šè¯„ä¼°

**âœ… åˆ¤å®šï¼šåŸºç¡€åˆç†ï¼Œä½†ç¼ºå°‘ç»†åˆ†**

**åˆ†æ**ï¼š
- 100% åˆ©ç”¨ç‡æ„å‘³ç€å…è®¸æ»¡ä»“ï¼Œè¿™åœ¨è‡ªåŠ¨äº¤æ˜“ä¸­ **æåº¦å±é™©**
- æœºæ„é£æ§é€šå¸¸è¦æ±‚ï¼š
  - æ—¥å¸¸äº¤æ˜“ï¼šâ‰¤ 60% åˆ©ç”¨ç‡
  - é«˜ç½®ä¿¡åº¦ä¿¡å·ï¼šâ‰¤ 80%
  - å‹åŠ›æµ‹è¯•æƒ…æ™¯ä¸‹ä»æœ‰ 20% ä½™é‡

**å…³é”®é—®é¢˜**ï¼š
```python
# risk_gate.py Line 493
position_utilization = _safe_float(risk_metrics.get("position_utilization"))
if position_utilization is None:
    position_utilization = _safe_float(risk_snapshot.get("position_utilization"))
```
- é€»è¾‘æ­£ç¡®ï¼Œä½† **æœªåŒºåˆ†è®¡åˆ’å¤´å¯¸ä¸å·²æœ‰å¤´å¯¸**
- å¦‚æœè´¦æˆ·å·²æŒæœ‰ 3000 ç›å¸ï¼Œæ–°è®¡åˆ’å†åŠ  2000ï¼Œæ€»è®¡ 5000ï¼ˆ100%ï¼‰ï¼Œç³»ç»Ÿä¼šæ”¾è¡Œ
- ä½†å®é™…ä¸Š **å¢é‡é£é™©** åº”å•ç‹¬è¯„ä¼°

#### å»ºè®®æ”¹è¿›

```python
# åˆ†çº§åˆ©ç”¨ç‡é™åˆ¶
hard_gate_max_position_utilization_routine: float = 0.6   # å¸¸è§„ 60%
hard_gate_max_position_utilization_elevated: float = 0.8  # ç‰¹æ®Šæƒ…å†µ 80%
hard_gate_max_position_utilization_hard_limit: float = 0.95  # ç¡¬é¡¶ 95%

# æ–°å¢ï¼šå¢é‡å¤´å¯¸è¯„ä¼°
def _evaluate_incremental_utilization(
    current_position_oz: float,
    planned_addition_oz: float,
    max_position_oz: float
) -> Dict[str, float]:
    """è¯„ä¼°å¢é‡å¤´å¯¸å ç”¨"""
    incremental_utilization = planned_addition_oz / max_position_oz
    total_utilization = (current_position_oz + planned_addition_oz) / max_position_oz
    
    return {
        "incremental_utilization": incremental_utilization,
        "total_utilization": total_utilization,
        "incremental_limit": 0.3,  # å•æ¬¡ä¸è¶…è¿‡ 30%
    }
```

---

### 1.5 å‹åŠ›æŸå¤±é™é¢ï¼ˆStress Loss Limitï¼‰

#### å½“å‰é…ç½®
```python
hard_gate_max_stress_loss_millions: float | None = None  # æœªè®¾ç½®
STRESS_VAR_MILLIONS = 3.0  # .env é…ç½®ï¼Œä½œä¸º fallback
```

#### ä¸“ä¸šè¯„ä¼°

**âš ï¸ åˆ¤å®šï¼šå­˜åœ¨é€»è¾‘æ¼æ´**

**é—®é¢˜**ï¼š
1. **é»˜è®¤å€¼ `None` å±é™©**ï¼š
```python
# risk_gate.py Line 570
stress_limit = settings.hard_gate_max_stress_loss_millions
if stress_limit is None:
    stress_limit = settings.stress_var_millions
```
- å¦‚æœä¸¤è€…éƒ½æœªé…ç½®ï¼Œ`stress_limit` ä»ä¸º `None`ï¼Œè·³è¿‡æ£€æŸ¥
- åº”è®¾ç½® **ç¡¬ç¼–ç ä¿åº•å€¼**

2. **æƒ…æ™¯è®¾è®¡å•ä¸€**ï¼š
```python
# risk.py Line 36
DEFAULT_SCENARIO_SHOCKS: Sequence[ScenarioShock] = (
    ScenarioShock(label="minus_2pct", pct_change=-0.02),
    ScenarioShock(label="minus_1pct", pct_change=-0.01),
    ScenarioShock(label="plus_1pct", pct_change=0.01),
    ScenarioShock(label="plus_2pct", pct_change=0.02),
)
```
- Â±2% å¯¹é»„é‡‘æ¥è¯´å±äº **å¸¸è§„æ³¢åŠ¨**ï¼Œä¸å¤Ÿæç«¯
- 2008 é‡‘èå±æœºã€2020 ç–«æƒ…æœŸé—´ï¼Œé»„é‡‘å•æ—¥æ³¢åŠ¨å¯è¾¾ **8-10%**

#### å»ºè®®æ”¹è¿›

```python
# è®¾ç½®ä¿å®ˆé»˜è®¤å€¼
hard_gate_max_stress_loss_millions: float = 2.0  # ä¸å…è®¸ None

# å¢å¼ºæƒ…æ™¯åº“
EXTREME_SCENARIO_SHOCKS: Sequence[ScenarioShock] = (
    ScenarioShock(label="black_swan_minus_10pct", pct_change=-0.10),
    ScenarioShock(label="flash_crash_minus_5pct", pct_change=-0.05),
    ScenarioShock(label="taper_tantrum_minus_3pct", pct_change=-0.03),
    ScenarioShock(label="normal_minus_2pct", pct_change=-0.02),
    # ... æ­£å‘æƒ…æ™¯
)

# åˆ†çº§æŸå¤±é˜ˆå€¼
stress_loss_warning = 1.5  # è§¦å‘è­¦å‘Š
stress_loss_limit = 3.0    # ç¡¬é˜»æ­¢
stress_loss_circuit_breaker = 5.0  # å¼ºåˆ¶å¹³ä»“æ‰€æœ‰å¤´å¯¸
```

---

### 1.6 ç›¸å…³æ€§é˜ˆå€¼ï¼ˆCorrelation Thresholdï¼‰

#### å½“å‰é…ç½®
```python
hard_gate_correlation_threshold: float | None = 0.9  # 0.9
```

#### ä¸“ä¸šè¯„ä¼°

**âŒ åˆ¤å®šï¼šä¸åˆç†ï¼Œé˜ˆå€¼è®¾ç½®è¿‡é«˜**

**ç°å®æ•°æ®**ï¼š
- **é»„é‡‘ vs ç¾å…ƒæŒ‡æ•°ï¼ˆDXYï¼‰**ï¼šå†å² 20 æ—¥æ»šåŠ¨ç›¸å…³æ€§å¸¸æ€åŒºé—´ **-0.7 è‡³ -0.9**
- **é»„é‡‘ vs ç¾å€º TLT**ï¼šæ­£ç›¸å…³ 0.6-0.8ï¼ˆé¿é™©èµ„äº§åŒæ¶¨ï¼‰
- **é»„é‡‘ vs æ ‡æ™® 500**ï¼šé€šå¸¸ -0.3 è‡³ 0.5ï¼ˆå±æœºæ—¶è½¬æ­£ç›¸å…³ï¼‰

**é—®é¢˜**ï¼š
1. é˜ˆå€¼ 0.9ï¼ˆç»å¯¹å€¼ï¼‰æ„å‘³ç€åªæœ‰**æç«¯å…±æŒ¯**æ‰è§¦å‘ï¼Œå½¢åŒè™šè®¾
2. ä»£ç æ­£ç¡®ä½¿ç”¨ `abs(value) >= threshold`ï¼Œä½†æ•°å€¼ä¸å½“
3. è¯¥å‚æ•°çš„çœŸæ­£ç›®çš„åº”è¯¥æ˜¯é˜²æ­¢ **ç»„åˆè¿‡åº¦é›†ä¸­äºå•ä¸€é£é™©å› å­**

#### å»ºè®®æ”¹è¿›

```python
# åˆ†çº§ç›¸å…³æ€§è­¦æŠ¥
hard_gate_correlation_warning_threshold: float = 0.6   # è­¦å‘Šï¼š60%
hard_gate_correlation_limit_threshold: float = 0.8     # é™åˆ¶ï¼š80%
hard_gate_correlation_block_threshold: float = 0.95    # é˜»æ­¢ï¼š95%

# æ–°å¢ï¼šé£é™©å› å­å¤šæ ·æ€§è¯„åˆ†
def _evaluate_diversification(correlations: List[float]) -> float:
    """
    è¿”å› 0-1ï¼Œè¶Šæ¥è¿‘ 1 è¡¨ç¤ºè¶Šåˆ†æ•£
    åŸºäº Herfindahl-Hirschman Index (HHI) æ”¹ç¼–
    """
    if not correlations:
        return 1.0
    
    avg_abs_corr = sum(abs(c) for c in correlations) / len(correlations)
    diversification_score = 1.0 - avg_abs_corr
    return max(0.0, diversification_score)

# è¦æ±‚ï¼šdiversification_score >= 0.3ï¼ˆå³å¹³å‡ç›¸å…³æ€§ â‰¤ 0.7ï¼‰
```

---

## äºŒã€æ•°æ®æºè´¨é‡ä¸é£æ§å†³ç­–åŒ¹é…åº¦

### 2.1 å½“å‰æ•°æ®æºè¯„ä¼°

ä»ä»£ç å®¡æŸ¥ï¼š
```python
# .env
DATA_PROVIDER=twelvedata
DATA_MODE=live
```

æ”¯æŒçš„æ•°æ®æºï¼š
- `yfinance`ï¼ˆé»˜è®¤ï¼Œå…è´¹ï¼‰
- `twelvedata`ï¼ˆå½“å‰ä½¿ç”¨ï¼Œæœ‰é™å…è´¹é¢åº¦ï¼‰
- `polygon.io`ï¼ˆé…ç½®ä½†æœªçŸ¥æ˜¯å¦ä»˜è´¹ï¼‰
- `tanshu`ï¼ˆå›ä¹¦ï¼Œå›½å†…é»„é‡‘æ•°æ®ï¼‰
- `alphavantage`ï¼ˆå¤–æ±‡æ•°æ®ï¼‰

### ä¸“ä¸šè¯„ä¼°

**âŒ åˆ¤å®šï¼šæ•°æ®è´¨é‡ä¸è¶³ä»¥æ”¯æ’‘å½“å‰ç¡¬é£æ§å‚æ•°çš„ä¸¥æ ¼åº¦**

**å…³é”®é—®é¢˜**ï¼š

#### 2.1.1 å»¶è¿Ÿï¼ˆLatencyï¼‰
- `yfinance` å»¶è¿Ÿï¼š**5-15 åˆ†é’Ÿ**
- `twelvedata` å…è´¹å±‚ï¼š**1-5 åˆ†é’Ÿ**
- **ç¡¬é£æ§è¦æ±‚**ï¼šå½“æ»‘ç‚¹ã€ä»·å·®æ£€æŸ¥å¦‚æ­¤ä¸¥æ ¼æ—¶ï¼Œéœ€è¦ **å‡†å®æ—¶æ•°æ®ï¼ˆâ‰¤ 1 ç§’ï¼‰**

#### 2.1.2 ç²¾åº¦ï¼ˆPrecisionï¼‰
- å…è´¹æ•°æ®æºé€šå¸¸åªæä¾› **OHLCV**ï¼ˆå¼€é«˜ä½æ”¶æˆäº¤é‡ï¼‰
- ç¼ºå°‘ï¼š
  - **Tick çº§ Bid/Ask æŠ¥ä»·**ï¼šæ— æ³•å‡†ç¡®è®¡ç®—å®æ—¶ä»·å·®
  - **Level 2 æ·±åº¦æ•°æ®**ï¼š`liquidity_depth` ä¼°ç®—ä¸å¯é 
  - **å®é™…æˆäº¤æµå‘**ï¼šæ— æ³•åŒºåˆ†ä¸»åŠ¨ä¹°ç›˜/å–ç›˜

#### 2.1.3 æµåŠ¨æ€§æŒ‡æ ‡çš„ä¼°ç®—è¯¯å·®

ä»ä»£ç ï¼š
```python
# risk_gate.py Line 420
estimated_depth_oz: Optional[float] = None
if latest_volume is not None:
    estimated_depth_oz = latest_volume * depth_ratio  # depth_ratio = 0.05
```

- ç”¨æˆäº¤é‡ä¼°ç®—å¸‚åœºæ·±åº¦ï¼Œå‡è®¾æ·±åº¦ = 5% Ã— æˆäº¤é‡
- **å®é™…æƒ…å†µ**ï¼šç›˜å£æ·±åº¦ä¸æˆäº¤é‡ç›¸å…³æ€§åœ¨é«˜é¢‘éœ‡è¡æœŸé—´**æä¸ç¨³å®š**
- TwelveData çš„ Volume æ˜¯ **æ—¥ç´¯è®¡**ï¼Œè€Œæ·±åº¦æ˜¯**ç¬æ—¶å¿«ç…§**ï¼Œä¸¤è€…ä¸åº”ç®€å•çº¿æ€§å…³ç³»

#### 2.1.4 ä»·å·®æ•°æ®çš„ç¼ºå¤±

```python
# risk.py Line 233
if highs is not None and lows is not None:
    high = float(highs.iloc[-1])
    low = float(lows.iloc[-1])
    spread_bps = ((high - low) / latest_price) * 10_000 / 2
```

- ç”¨ **æ—¥å†…æœ€é«˜ä»·å’Œæœ€ä½ä»·å·®å€¼** ä¼°ç®—ä»·å·®
- é—®é¢˜ï¼šè¿™æ˜¯ **æ—¥æ³¢åŠ¨å¹…åº¦**ï¼Œä¸æ˜¯ **ä¹°å–ä»·å·®ï¼ˆBid-Ask Spreadï¼‰**
- çœŸå®ä»·å·®é€šå¸¸ä»… 0.5-1.5 ç¾å…ƒï¼ˆ5-15 åŸºç‚¹ï¼‰ï¼Œè€Œä»£ç è®¡ç®—å‡ºçš„å€¼å¯èƒ½æ˜¯ **30-50 åŸºç‚¹**

### 2.2 æ•°æ®æºä¸é£æ§å‚æ•°çš„çŸ›ç›¾

| é£æ§å‚æ•° | è¦æ±‚æ•°æ®ç²¾åº¦ | å½“å‰æ•°æ®æºèƒ½åŠ› | åŒ¹é…åº¦ |
|---------|-------------|---------------|--------|
| æ­¢æŸè·ç¦» 0.1% | Tick çº§ä»·æ ¼ | 1 åˆ†é’Ÿ OHLC | âŒ ä¸åŒ¹é… |
| ä»·å·® â‰¤ 25bps | å®æ—¶ Bid/Ask | æ—¥ High-Low ä¼°ç®— | âŒ ä¸åŒ¹é… |
| æµåŠ¨æ€§æ·±åº¦ 1500oz | Level 2 æ·±åº¦ | æˆäº¤é‡Ã—5% ä¼°ç®— | âš ï¸ å‹‰å¼º |
| æ»‘ç‚¹ â‰¤ 35bps | å†å²æˆäº¤å†²å‡»åˆ†æ | ATRÃ—è§„æ¨¡æ¨ç®— | âœ… åŸºæœ¬å¯ç”¨ |

### å»ºè®®å‡çº§è·¯å¾„

**çŸ­æœŸï¼ˆä¿æŒç°æœ‰æ•°æ®æºï¼‰**ï¼š
1. **æ”¾å®½é˜ˆå€¼**ä»¥åŒ¹é…æ•°æ®è´¨é‡ï¼š
```python
hard_gate_max_spread_bps: float = 50.0  # ä» 25 æå‡åˆ° 50
hard_gate_min_liquidity_depth_oz: float = 500.0  # ä» 1500 é™è‡³ 500
hard_gate_min_stop_distance_pct: float = 0.5  # ä» 0.1 æå‡åˆ° 0.5
```

2. **å¢åŠ æ•°æ®æ–°é²œåº¦æ£€æŸ¥**ï¼š
```python
# å½“å‰å·²æœ‰é€»è¾‘
market_data_max_age_minutes: int = 1440  # 24 å°æ—¶

# å»ºè®®æ”¹ä¸º
market_data_max_age_minutes: int = 30  # ç¡¬é£æ§å‰å¼ºåˆ¶ 30 åˆ†é’Ÿå†…æ•°æ®
# å¹¶åœ¨ risk_gate.py ä¸­å¢åŠ 
if data_age_minutes > 30:
    raise DataStalenessError("æ•°æ®è¿‡æ—§ï¼Œç¡¬é£æ§æ‹’ç»å†³ç­–")
```

**ä¸­æœŸï¼ˆæ¨èå‡çº§ï¼‰**ï¼š
- **Polygon.io**ï¼ˆæ¯æœˆ $99ï¼Œå®æ—¶æ•°æ®ï¼‰
- **Interactive Brokers API**ï¼ˆå·²æœ‰é€‚é…å™¨ï¼Œä½†éœ€äº¤æ˜“è´¦æˆ·ï¼‰
- **CoinAPI æˆ– Kaiko**ï¼ˆåŠ å¯†è´§å¸é£æ ¼çš„è´µé‡‘å±æ•°æ®ï¼Œä½å»¶è¿Ÿï¼‰

**é•¿æœŸï¼ˆæœºæ„çº§ï¼‰**ï¼š
- **Bloomberg Terminal** æˆ– **Refinitiv Eikon**
- **ä¸“ä¸š ECN è¿æ¥**ï¼ˆå¦‚ EBSã€Currenexï¼‰

---

## ä¸‰ã€é£æ§é€»è¾‘ç¼ºé™·ä¸æ”¹è¿›å»ºè®®

### 3.1 æ­¢æŸæ–¹å‘éªŒè¯æ¼æ´

**å·²æœ‰é€»è¾‘**ï¼š
```python
# risk_gate.py Line 241
expected_direction_valid = True
if side == "LONG" and stop_price >= entry_price:
    expected_direction_valid = False
if side == "SHORT" and stop_price <= entry_price:
    expected_direction_valid = False
```

**âœ… é€»è¾‘æ­£ç¡®**ï¼Œä½†æœ‰æ”¹è¿›ç©ºé—´ï¼š

**é—®é¢˜**ï¼š
- æœªå¤„ç† **è¿½è¸ªæ­¢æŸï¼ˆTrailing Stopï¼‰** åœºæ™¯
- æœªéªŒè¯ **æ­¢ç›ˆï¼ˆTake Profitï¼‰æ˜¯å¦ä¸æ­¢æŸçŸ›ç›¾**

**å»ºè®®æ–°å¢**ï¼š
```python
# éªŒè¯æ­¢ç›ˆæ­¢æŸé€»è¾‘ä¸€è‡´æ€§
if side == "LONG":
    if stop_price >= entry_price:
        violations.append("STOP_ABOVE_ENTRY_LONG")
    if take_profit and take_profit <= entry_price:
        violations.append("TARGET_BELOW_ENTRY_LONG")
    if take_profit and stop_price and take_profit <= stop_price:
        violations.append("TARGET_BELOW_STOP")  # é£æŠ¥æ¯”å¼‚å¸¸
```

### 3.2 å•ç¬”è®¢å•é™åˆ¶ç¼ºå¤±ç‹¬ç«‹é…ç½®

**å½“å‰é€»è¾‘**ï¼š
```python
# risk_gate.py Line 518
single_order_limit = settings.hard_gate_max_single_order_oz
if single_order_limit is None:
    single_order_limit = settings.compliance_max_single_order_oz or settings.max_position_oz
```

**é—®é¢˜**ï¼š
- `hard_gate_max_single_order_oz` é»˜è®¤ä¸º `None`ï¼Œä¾èµ– `compliance` å±‚é…ç½®
- åˆè§„å±‚ï¼ˆComplianceï¼‰æ˜¯**è½¯çº¦æŸ**ï¼Œåº”ä¸ç¡¬é£æ§éš”ç¦»
- `.env` ä¸­åªæœ‰ `COMPLIANCE_MAX_SINGLE_ORDER_OZ=3000`ï¼Œæ— ç¡¬é£æ§ç‹¬ç«‹é…ç½®

**å»ºè®®**ï¼š
```python
# settings.py
hard_gate_max_single_order_oz: float = 2000.0  # ä¸å…è®¸ Noneï¼Œç‹¬ç«‹é…ç½®
# ä¸”åº”è¯¥ < compliance_max_single_order_ozï¼Œå½¢æˆåŒä¿é™©
```

### 3.3 å¸‚åœºæµåŠ¨æ€§åˆ†æ—¶æ®µå·®å¼‚æœªè€ƒè™‘

**é—®é¢˜**ï¼š
- æµåŠ¨æ€§é˜ˆå€¼å…¨å¤©ç»Ÿä¸€
- å®é™…ä¸Šï¼š
  - **ä¼¦æ•¦/çº½çº¦é‡å æ—¶æ®µ**ï¼ˆUTC 13:00-17:00ï¼‰ï¼šæµåŠ¨æ€§æœ€ä½³
  - **äºšæ´²æ—¶æ®µ**ï¼ˆUTC 00:00-08:00ï¼‰ï¼šæµåŠ¨æ€§å·® 50%
  - **å‘¨æœ«/å‡æœŸ**ï¼šå‡ ä¹æ— æµåŠ¨æ€§

**å»ºè®®æ–°å¢**ï¼š
```python
def _adjust_liquidity_thresholds_by_session(
    base_threshold: float,
    timestamp: datetime
) -> float:
    """æ ¹æ®äº¤æ˜“æ—¶æ®µåŠ¨æ€è°ƒæ•´æµåŠ¨æ€§è¦æ±‚"""
    hour_utc = timestamp.hour
    
    # æ¬§ç¾é‡å æ—¶æ®µï¼ˆ13:00-17:00 UTCï¼‰
    if 13 <= hour_utc < 17:
        return base_threshold  # æ ‡å‡†å€¼
    
    # ä¼¦æ•¦æ—¶æ®µï¼ˆ07:00-16:00 UTCï¼‰
    elif 7 <= hour_utc < 16:
        return base_threshold * 1.2  # æ”¾å®½ 20%
    
    # äºšæ´²æ—¶æ®µ
    elif 0 <= hour_utc < 7:
        return base_threshold * 1.5  # æ”¾å®½ 50%
    
    # çº½çº¦å°¾ç›˜
    else:
        return base_threshold * 1.3
```

### 3.4 VaR ä¸å‹åŠ›æµ‹è¯•çš„ååŒä¸è¶³

**å½“å‰åˆ†ç¦»è¯„ä¼°**ï¼š
```python
# risk.py è®¡ç®— historical_var_99
# risk_gate.py è¯„ä¼° stress_test_worst_loss_millions
```

**é—®é¢˜**ï¼š
- VaRï¼ˆ99% ç½®ä¿¡åº¦ï¼‰å‡è®¾**æ­£æ€åˆ†å¸ƒ**ï¼Œä½ä¼°å°¾éƒ¨é£é™©
- å‹åŠ›æµ‹è¯•æƒ…æ™¯è¿‡äºæ¸©å’Œï¼ˆÂ±2%ï¼‰
- ä¸¤è€…æœªè”åŠ¨æ ¡éªŒ

**å»ºè®®é›†æˆ**ï¼š
```python
def _evaluate_tail_risk(
    historical_var_99: float,
    stress_loss: float,
    position_oz: float,
    latest_price: float
) -> Dict[str, Any]:
    """è¯„ä¼°å°¾éƒ¨é£é™©ä¸€è‡´æ€§"""
    
    # VaR è½¬æ¢ä¸ºæŸå¤±é‡‘é¢
    var_loss = abs(historical_var_99) * position_oz * latest_price / 1_000_000
    
    # å‹åŠ›æŸå¤±åº” >= VaR æŸå¤±ï¼ˆå‹åŠ›æµ‹è¯•æ›´æç«¯ï¼‰
    if stress_loss > 0 or abs(stress_loss) < var_loss * 1.5:
        violations.append(
            HardRiskViolation(
                code="STRESS_VAR_INCONSISTENCY",
                message=f"å‹åŠ›æŸå¤± {stress_loss:.2f}M å°äº VaR æŸå¤± {var_loss:.2f}M çš„ 1.5 å€",
                details={"var_loss": var_loss, "stress_loss": stress_loss}
            )
        )
    
    return {"var_loss_millions": var_loss, "stress_multiplier": abs(stress_loss / var_loss) if var_loss else None}
```

---

## å››ã€æ¨èé…ç½®æ–¹æ¡ˆ

åŸºäºä»¥ä¸Šåˆ†æï¼Œæä¾›ä¸‰å¥—åœºæ™¯åŒ–é…ç½®ï¼š

### æ–¹æ¡ˆ Aï¼šä¿å®ˆå‹ï¼ˆèµ„é‡‘å®‰å…¨ç¬¬ä¸€ï¼Œé€‚åˆåˆæœŸæµ‹è¯•ï¼‰

```bash
# .env é…ç½®
MAX_POSITION_OZ=3000                          # é™ä½æ€»ä»“ä½
STRESS_VAR_MILLIONS=1.5                       # ä¸¥æ ¼æŸå¤±ä¸Šé™
DAILY_DRAWDOWN_PCT=2.0                        # 2% å›æ’¤å³åœ

# ç¡¬é£æ§
HARD_GATE_MAX_POSITION_UTILIZATION=0.6        # æœ€å¤š 60% ä»“ä½
HARD_GATE_MAX_SINGLE_ORDER_OZ=800             # å•ç¬”é™åˆ¶ 800 ç›å¸
HARD_GATE_MIN_STOP_DISTANCE_PCT=0.5           # æœ€å°æ­¢æŸ 0.5%
HARD_GATE_MAX_STOP_DISTANCE_PCT=3.0           # æœ€å¤§æ­¢æŸ 3%
HARD_GATE_STOP_COVERAGE_RATIO=1.0             # 100% æ­¢æŸè¦†ç›–
HARD_GATE_MIN_LIQUIDITY_DEPTH_OZ=500          # é™è‡³ 500
HARD_GATE_MAX_SPREAD_BPS=50.0                 # æ”¾å®½è‡³ 50
HARD_GATE_MAX_SLIPPAGE_BPS=60.0               # æ”¾å®½è‡³ 60
HARD_GATE_CORRELATION_THRESHOLD=0.85          # é™è‡³ 0.85
```

**é€‚ç”¨åœºæ™¯**ï¼š
- è‡ªåŠ¨åŒ–ç¨‹åº¦ä½ï¼Œäººå·¥å¤æ ¸ä¸ºä¸»
- æ•°æ®æºä¸º yfinance æˆ– twelvedata å…è´¹ç‰ˆ
- ä¸»è¦ç”¨äº**ä¿¡å·ç”Ÿæˆ**ï¼Œä¸ç›´æ¥æ‰§è¡Œ

---

### æ–¹æ¡ˆ Bï¼šå¹³è¡¡å‹ï¼ˆæ¨èï¼Œé€‚åˆæ³¢æ®µäº¤æ˜“ï¼‰

```bash
MAX_POSITION_OZ=5000
STRESS_VAR_MILLIONS=3.0
DAILY_DRAWDOWN_PCT=3.0

HARD_GATE_MAX_POSITION_UTILIZATION=0.75       # 75% åˆ©ç”¨ç‡
HARD_GATE_MAX_SINGLE_ORDER_OZ=1500            # å•ç¬” 1500
HARD_GATE_MIN_STOP_DISTANCE_PCT=0.5           # 0.5%
HARD_GATE_MAX_STOP_DISTANCE_PCT=5.0           # 5%ï¼ˆå…è®¸æ›´å®½æ­¢æŸï¼‰
HARD_GATE_STOP_COVERAGE_RATIO=1.0
HARD_GATE_MIN_LIQUIDITY_DEPTH_OZ=800
HARD_GATE_MAX_SPREAD_BPS=40.0
HARD_GATE_MAX_SLIPPAGE_BPS=50.0
HARD_GATE_LIQUIDITY_BASELINE_OZ=3000          # æå‡åŸºçº¿
HARD_GATE_CORRELATION_THRESHOLD=0.75          # 0.75
```

**é€‚ç”¨åœºæ™¯**ï¼š
- æŒä»“å‘¨æœŸ **1-5 å¤©**
- ä½¿ç”¨ Polygon.io æˆ– IBKR å®æ—¶æ•°æ®
- åŠè‡ªåŠ¨åŒ–ï¼šAgent ç”Ÿæˆè®¡åˆ’ï¼Œäººå·¥å®¡æ‰¹åæ‰§è¡Œ

---

### æ–¹æ¡ˆ Cï¼šæ¿€è¿›å‹ï¼ˆä»…ä¾›å‚è€ƒï¼Œéœ€ä¸“ä¸šç›‘ç£ï¼‰

```bash
MAX_POSITION_OZ=10000                         # é«˜ä»“ä½
STRESS_VAR_MILLIONS=5.0
DAILY_DRAWDOWN_PCT=5.0

HARD_GATE_MAX_POSITION_UTILIZATION=0.85
HARD_GATE_MAX_SINGLE_ORDER_OZ=3000
HARD_GATE_MIN_STOP_DISTANCE_PCT=0.3           # æ›´ç´§æ­¢æŸ
HARD_GATE_MAX_STOP_DISTANCE_PCT=8.0           # æ›´å®½æ­¢æŸ
HARD_GATE_STOP_COVERAGE_RATIO=0.9             # å…è®¸ 10% è£¸ä»“
HARD_GATE_MIN_LIQUIDITY_DEPTH_OZ=1500
HARD_GATE_MAX_SPREAD_BPS=60.0
HARD_GATE_MAX_SLIPPAGE_BPS=80.0
HARD_GATE_CORRELATION_THRESHOLD=0.7
```

**é£é™©è­¦å‘Š**ï¼š
- éœ€è¦ **Bloomberg çº§æ•°æ®æº**
- å¿…é¡»é…å¤‡ **24 å°æ—¶äººå·¥ç›‘æ§**
- å»ºè®®å…ˆç”¨å°èµ„é‡‘å®ç›˜éªŒè¯è‡³å°‘ **3 ä¸ªæœˆ**

---

## äº”ã€å…¶ä»–ä¸“ä¸šå»ºè®®

### 5.1 å¢åŠ ç†”æ–­æœºåˆ¶ï¼ˆCircuit Breakerï¼‰

**å½“å‰ç¼ºå¤±**ï¼šç³»ç»Ÿæ— å…¨å±€æ€§ç´§æ€¥åœæœºé€»è¾‘

**å»ºè®®æ–°å¢**ï¼š
```python
class CircuitBreaker:
    """å…¨å±€ç†”æ–­å™¨ï¼Œè§¦å‘åé˜»æ­¢æ‰€æœ‰æ–°äº¤æ˜“"""
    
    def __init__(self, settings: Settings):
        self.enabled = True
        self.triggers = {
            "max_consecutive_losses": 5,      # è¿ç»­ 5 ç¬”äºæŸ
            "daily_loss_limit": -2.0,          # å½“æ—¥äºæŸ 2M
            "spike_vol_threshold": 3.0,        # æ³¢åŠ¨ç‡çªå¢ 3 å€
        }
    
    def check(self, state: PortfolioState) -> bool:
        if state.consecutive_losses >= self.triggers["max_consecutive_losses"]:
            logger.critical("ç†”æ–­è§¦å‘ï¼šè¿ç»­äºæŸè¾¾åˆ°ä¸Šé™")
            return False
        
        if state.pnl_today < self.triggers["daily_loss_limit"]:
            logger.critical("ç†”æ–­è§¦å‘ï¼šå½“æ—¥äºæŸè¶…é™")
            return False
        
        # ... å…¶ä»–æ£€æŸ¥
        return True
```

### 5.2 å›æµ‹ä¸å‚æ•°ä¼˜åŒ–

**é—®é¢˜**ï¼šå½“å‰å‚æ•°ä¼¼ä¹ä¸º**æ‹è„‘è¢‹è®¾å®š**ï¼Œç¼ºå°‘å†å²éªŒè¯

**å»ºè®®æµç¨‹**ï¼š
1. æ”¶é›† **2020-2024** é»„é‡‘å†å²æ•°æ®ï¼ˆåŒ…å«ç–«æƒ…ã€åŠ æ¯å‘¨æœŸç­‰æç«¯è¡Œæƒ…ï¼‰
2. å›æµ‹ä¸åŒå‚æ•°ç»„åˆï¼š
   - æ­¢æŸè·ç¦»ï¼š[0.3%, 0.5%, 1.0%, 1.5%, 2.0%]
   - ä»“ä½åˆ©ç”¨ç‡ï¼š[0.5, 0.6, 0.75, 0.9]
   - æ­¢æŸè¦†ç›–ç‡ï¼š[0.8, 1.0]
3. è¯„ä¼°æŒ‡æ ‡ï¼š
   - **å¤æ™®æ¯”ç‡ï¼ˆSharpe Ratioï¼‰**
   - **æœ€å¤§å›æ’¤ï¼ˆMax Drawdownï¼‰**
   - **èƒœç‡ä¸èµ”ç‡**
   - **ç¡¬é£æ§è¯¯è§¦å‘ç‡**ï¼ˆFalse Positive Rateï¼‰

### 5.3 Agent è§’è‰²åˆ†å·¥ä¼˜åŒ–

**è§‚å¯Ÿåˆ°çš„é—®é¢˜**ï¼š
- `QuantResearchAgent` è¢«èµ‹äºˆä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œä½† LLM æ•°å­¦èƒ½åŠ›æœ‰é™
- å»ºè®®ï¼šå°†é‡åŒ–è®¡ç®—**å®Œå…¨å‰¥ç¦»**ç»™ `quant_helpers.py` ç¡¬ç¼–ç å·¥å…·
- Agent ä»…è´Ÿè´£**è§£è¯»ç»“æœ**ï¼Œä¸å‚ä¸è®¡ç®—

**æ¨èæ¶æ„**ï¼š
```
DataAgentï¼ˆè·å–æ•°æ®ï¼‰
   â†“
QuantEngineï¼ˆçº¯ Pythonï¼Œè®¡ç®— RSI/MACD/VaRï¼‰  â† ä¸ç»è¿‡ LLM
   â†“
QuantResearchAgentï¼ˆè§£è¯»æŒ‡æ ‡ï¼Œæä¾›äº¤æ˜“å»ºè®®ï¼‰
   â†“
HeadTraderï¼ˆæ•´åˆå»ºè®®ï¼Œç”Ÿæˆè®¡åˆ’ï¼‰
   â†“
RiskGateï¼ˆç¡¬é£æ§ï¼Œçº¯ Python è§„åˆ™ï¼‰
```

### 5.4 ç›‘ç®¡ä¸å®¡è®¡æ—¥å¿—

**å½“å‰çŠ¶å†µ**ï¼šæœ‰æ—¥å¿—è®°å½•ï¼Œä½†æœªç»“æ„åŒ–å­˜å‚¨

**å»ºè®®**ï¼š
```python
# æ¯ç¬”äº¤æ˜“å†³ç­–è®°å½•åˆ°æ•°æ®åº“
trade_decision_log = {
    "timestamp": datetime.utcnow(),
    "session_id": uuid4(),
    "agent_recommendations": {...},
    "risk_gate_report": {...},
    "approved": True/False,
    "rejection_reason": "STOP_DISTANCE_TOO_WIDE" if rejected else None,
    "executed": False,  # å®é™…æ˜¯å¦ä¸‹å•
    "pnl_realized": None,  # äº‹åè¿½è¸ª
}
```

**ç”¨é€”**ï¼š
- ç›‘ç®¡å®¡è®¡ï¼ˆMiFID II, Dodd-Frank åˆè§„ï¼‰
- æ¨¡å‹æ€§èƒ½è¿½è¸ª
- æ³•å¾‹çº çº·è¯æ®é“¾

---

## å…­ã€ç›ˆåˆ©å¯è¡Œæ€§æœ€ç»ˆè¯„ä¼°

### çŸ­æœŸï¼ˆ1-3 ä¸ªæœˆï¼‰
- **å½“å‰é…ç½®**ï¼šâŒ ä¸å»ºè®®å…¨è‡ªåŠ¨äº¤æ˜“
  - å‡è­¦æŠ¥è¿‡å¤š â†’ é”™å¤±æœºä¼šæˆæœ¬é«˜
  - æ•°æ®è´¨é‡ä¸è¶³ â†’ åˆ¤æ–­å¤±è¯¯é£é™©å¤§
  
- **å»ºè®®æ¨¡å¼**ï¼šâœ… è¾…åŠ©å†³ç­–ç³»ç»Ÿ
  - Agent æ¯æ—¥ç”ŸæˆæŠ¥å‘Š
  - äººå·¥å®¡é˜…åæ‰‹åŠ¨ä¸‹å•
  - **é¢„æœŸä»·å€¼**ï¼šæ¯æ—¥èŠ‚çœ 2-3 å°æ—¶ç ”ç©¶æ—¶é—´ï¼Œé—´æ¥æå‡å†³ç­–æ•ˆç‡

### ä¸­æœŸï¼ˆ3-12 ä¸ªæœˆï¼‰
- **å¿…è¦æ”¹è¿›**ï¼š
  1. å‡çº§æ•°æ®æºï¼ˆPolygon.io æˆ– IBKRï¼‰
  2. æŒ‰æœ¬æŠ¥å‘Šè°ƒæ•´é£æ§å‚æ•°
  3. ç§¯ç´¯ 3 ä¸ªæœˆå®ç›˜æ•°æ®ï¼Œä¼˜åŒ–å‚æ•°
  
- **å¯è¡Œæ€§**ï¼šâš ï¸ åŠè‡ªåŠ¨åŒ–æœ‰ç›ˆåˆ©æ½œåŠ›
  - ä¸“æ³¨**å®è§‚äº‹ä»¶é©±åŠ¨ç­–ç•¥**ï¼ˆç¾è”å‚¨å†³è®®ã€åœ°ç¼˜å†²çªï¼‰
  - æ³¢æ®µæŒä»“ 3-7 å¤©ï¼Œé¿å¼€æ—¥å†…å™ªéŸ³
  - **ç›®æ ‡**ï¼šå¹´åŒ–æ”¶ç›Šç‡ 8-15%ï¼Œæœ€å¤§å›æ’¤ < 10%

### é•¿æœŸï¼ˆ1 å¹´ä»¥ä¸Šï¼‰
- **å…¨è‡ªåŠ¨åŒ–å¯è¡Œæ€§**ï¼šâœ… æœ‰æ¡ä»¶å¯è¡Œ
  - å‰ææ¡ä»¶ï¼š
    - **æœºæ„çº§æ•°æ®æº**ï¼ˆBloomberg/Reutersï¼‰
    - **ä¸“ä¸šç›‘ç®¡å›¢é˜Ÿ**ï¼ˆ24 å°æ—¶ç›‘æ§ï¼‰
    - **ç›‘ç®¡ç‰Œç…§**ï¼ˆè‹¥èµ„é‡‘è§„æ¨¡è¶…è¿‡ 100 ä¸‡ç¾å…ƒï¼‰
  
- **ç›ˆåˆ©å¤©èŠ±æ¿**ï¼š
  - æ³¢æ®µç­–ç•¥ï¼šå¹´åŒ– 15-25%
  - å¥—åˆ©ç­–ç•¥ï¼ˆé‡‘é“¶æ¯”ï¼‰ï¼šå¹´åŒ– 8-12%ï¼Œä½å›æ’¤
  - **ä¸å»ºè®®**é«˜é¢‘ç­–ç•¥ï¼ˆéœ€å¾®ç§’çº§åŸºç¡€è®¾æ–½ï¼‰

---

## ä¸ƒã€ç»“è®ºä¸è¡ŒåŠ¨å»ºè®®

### 7.1 ç¡¬é£æ§è®¾ç½®æ€»ä½“è¯„ä»·

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| æ¶æ„è®¾è®¡ | â­â­â­â­â­ | å¤šå±‚é£æ§ã€å¼‚å¸¸åˆ†ç¦»ã€ä»£ç è´¨é‡ä¼˜ç§€ |
| å‚æ•°åˆç†æ€§ | â­â­â­ | éƒ¨åˆ†è¿‡ä¸¥ï¼Œä¸æ•°æ®æºèƒ½åŠ›ä¸åŒ¹é… |
| å¯æ‰§è¡Œæ€§ | â­â­ | å½“å‰é…ç½®å‡è­¦æŠ¥ç‡è¿‡é«˜ |
| å®‰å…¨æ€§ | â­â­â­â­ | ä¿å®ˆä½†æœ‰æ•ˆï¼Œé€‚åˆåˆæœŸæµ‹è¯• |
| ç›ˆåˆ©æ½œåŠ› | â­â­â­ | éœ€æ”¹è¿›åå¯å®ç°ç¨³å®šç›ˆåˆ© |

### 7.2 ç«‹å³è¡ŒåŠ¨æ¸…å•

**ä¼˜å…ˆçº§ P0ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰**ï¼š
1. âœ… å°† `hard_gate_min_stop_distance_pct` ä» 0.1% æå‡è‡³ **0.5%**
2. âœ… å°† `hard_gate_max_spread_bps` ä» 25 æå‡è‡³ **40**
3. âœ… å°† `hard_gate_min_liquidity_depth_oz` ä» 1500 é™è‡³ **800**
4. âœ… è®¾ç½® `hard_gate_max_single_order_oz = 2000`ï¼ˆä¸ä¾èµ–åˆè§„å±‚ï¼‰
5. âœ… å¢åŠ æ•°æ®æ–°é²œåº¦å¼ºåˆ¶æ£€æŸ¥ï¼ˆ30 åˆ†é’Ÿå†…ï¼‰

**ä¼˜å…ˆçº§ P1ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰**ï¼š
6. âš ï¸ å‡çº§æ•°æ®æºè‡³ Polygon.io æˆ– IBKR
7. âš ï¸ å®æ–½ç†”æ–­æœºåˆ¶ï¼ˆè¿ç»­äºæŸ 5 ç¬”å³åœï¼‰
8. âš ï¸ å›æµ‹ 2020-2024 æ•°æ®ä¼˜åŒ–å‚æ•°
9. âš ï¸ å¢åŠ åˆ†æ—¶æ®µæµåŠ¨æ€§è°ƒæ•´é€»è¾‘
10. âš ï¸ VaR ä¸å‹åŠ›æµ‹è¯•ååŒéªŒè¯

**ä¼˜å…ˆçº§ P2ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰**ï¼š
11. ğŸ“‹ å»ºç«‹ç»“æ„åŒ–äº¤æ˜“å†³ç­–æ—¥å¿—
12. ğŸ“‹ å¢åŠ é£æŠ¥æ¯”éªŒè¯ï¼ˆæ­¢ç›ˆæ­¢æŸåè°ƒæ€§ï¼‰
13. ğŸ“‹ å®æ–½å¢é‡å¤´å¯¸åˆ©ç”¨ç‡è¯„ä¼°
14. ğŸ“‹ å¢å¼ºæƒ…æ™¯åº“ï¼ˆé»‘å¤©é¹…äº‹ä»¶ï¼‰

### 7.3 æœ€ç»ˆä¸“ä¸šå»ºè®®

**ä½œä¸ºä¸€ä½å››åå¹´ç»éªŒçš„äº¤æ˜“å‘˜ï¼Œæˆ‘å¿…é¡»å¦è¯šåœ°è¯´**ï¼š

âœ… **ä½ çš„ç³»ç»Ÿæ¶æ„æ˜¯æˆ‘è§è¿‡çš„ä¸šä½™é¡¹ç›®ä¸­æœ€æ¥è¿‘æœºæ„æ ‡å‡†çš„**ã€‚ä»£ç è´¨é‡ã€é£æ§åˆ†å±‚ã€Agent åä½œé€»è¾‘éƒ½ä½“ç°äº†æ·±åšçš„é‡‘èå·¥ç¨‹ç†è§£ã€‚

âš ï¸ **ä½†"èƒ½è¿è¡Œ"ä¸"èƒ½ç›ˆåˆ©"æ˜¯ä¸¤å›äº‹**ã€‚å½“å‰é…ç½®å°±åƒç»™ä¸€è¾†è·‘è½¦è£…ä¸Šäº†è‡ªè¡Œè½¦åˆ¹è½¦â€”â€”è¿‡åº¦è°¨æ…åè€Œé™åˆ¶äº†æ€§èƒ½ã€‚

ğŸ¯ **æˆ‘çš„å»ºè®®**ï¼š
1. å…ˆæŒ‰**æ–¹æ¡ˆ Bï¼ˆå¹³è¡¡å‹ï¼‰**è¿è¡Œ **æ¨¡æ‹Ÿç›˜** 3 ä¸ªæœˆ
2. è®°å½•æ‰€æœ‰ç¡¬é£æ§è§¦å‘æƒ…å†µï¼Œåˆ†æå‡è­¦æŠ¥ç‡
3. ç”¨å°èµ„é‡‘ï¼ˆ< 1 ä¸‡ç¾å…ƒï¼‰å®ç›˜æµ‹è¯•ï¼Œ**ä»…åšæ³¢æ®µäº¤æ˜“**
4. **ä¸è¦åœ¨ç–«æƒ…ã€æˆ˜äº‰ç­‰é»‘å¤©é¹…æœŸé—´è‡ªåŠ¨æ‰§è¡Œ**
5. å§‹ç»ˆä¿ç•™æœ€ç»ˆæ‰§è¡Œçš„**äººå·¥ç¡®è®¤æŒ‰é’®**

**è®°ä½åå°”è¡—é“å¾‹**ï¼š
> "In God we trust, all others must bring data."  
> ï¼ˆé™¤äº†ä¸Šå¸ï¼Œå…¶ä»–äººéƒ½è¦æ‹¿æ•°æ®è¯´è¯ï¼‰

ç¥äº¤æ˜“é¡ºåˆ©ï¼ä¿ä½æœ¬é‡‘æ¯”è¿½é€æš´åˆ©æ›´é‡è¦ã€‚

---

**æŠ¥å‘Šå®Œæˆæ—¥æœŸ**ï¼š2025å¹´12æœˆ5æ—¥  
**åˆ†æå¸ˆç­¾å**ï¼š[å››åå¹´é»„é‡‘äº¤æ˜“ç²¾ç®—å¸ˆ]  
**ä¸‹æ¬¡å®¡æŸ¥å»ºè®®**ï¼šå®ç›˜è¿è¡Œ 3 ä¸ªæœˆåï¼Œæˆ–å‚æ•°è°ƒæ•´å
