Metadata-Version: 2.4
Name: autogentest1
Version: 0.2.0
Summary: Multi-agent AutoGen workflow for gold trading analytics powered by DeepSeek.
Requires-Python: >=3.10
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: pyautogen>=0.2.1
Requires-Dist: pandas>=2.0
Requires-Dist: numpy>=1.26
Requires-Dist: yfinance>=0.2
Requires-Dist: ta>=0.11
Requires-Dist: feedparser>=6.0
Requires-Dist: pydantic>=2.5
Requires-Dist: python-dotenv>=1.0
Requires-Dist: matplotlib>=3.8
Requires-Dist: plotly>=5.18
Requires-Dist: json-repair>=0.2
Requires-Dist: requests-cache>=1.2
Requires-Dist: chromadb>=0.5
Provides-Extra: dev
Requires-Dist: pytest>=7.4; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21; extra == "dev"
Dynamic: license-file

# AutoGen DeepSeek 黄金分析

面向黄金交易场景的多智能体 AutoGen 工作流，模拟真实的研究→交易→风控→结算链路。系统挖掘宏观/技术/量化信号、执行策略推演，并通过硬风控闸门确保输出符合限额、止损与监管要求。

## TL;DR（给同事的速览）
- **多智能体流程**：Data→Phase1 研究→HeadTrader 定调→纸面交易→Risk/Compliance 审核→Settlement 收尾，全程 JSON 结构化，支持重试与拒单回炉。
- **统一行情入口**：`services.market_data.fetch_price_history` 将 TwelveData / Polygon / YFinance 等供应商装入适配器，并实现缓存、降级、Mock 回退。
- **风控硬闸**：`services.risk_gate.evaluate_plan` 在 CLI 层强制执行仓位利用率、单笔敞口、止损覆盖、压力损失、当日回撤、相关性等指标，一旦违规即抛出 `HardRiskBreachError`。
- **知识检索**：RAG 服务基于 Chroma（本地持久化），通过 `scripts/ingest_macro_history.py` 管理宏观案例 / 交易剧本，并在 ToolsProxy 中暴露查询接口。
- **扩展性**：Pydantic Settings 驱动 `.env` 配置；工具层已有套利、组合、合规辅助模块；README 末尾列出所有启动命令与关键参数。

## 系统总览
智能体全部基于 DeepSeek（可选本地模型）运行，Supervisor 与 ToolsProxy 将计算、行情、检索等需求统一调度。

```mermaid
flowchart LR
    subgraph Phase1[Phase 1 - Research]
        DataAgent --> TechAnalystAgent
        TechAnalystAgent --> MacroAnalystAgent
        MacroAnalystAgent --> FundamentalAnalystAgent
        FundamentalAnalystAgent --> QuantResearchAgent
    end
    Phase1 --> HeadTraderAgent
    HeadTraderAgent --> PaperTraderAgent
    PaperTraderAgent --> RiskManagerAgent
    RiskManagerAgent --> ComplianceAgent
    ComplianceAgent --> SettlementAgent
    ToolsProxy -.-> DataProviders[(Market Data Adapter)]
    ToolsProxy -.-> QuantHelpers[(Quant Helpers)]
    ToolsProxy -.-> RagService[(RAG Index)]
    RiskManagerAgent -->|HardRiskBreach| HeadTraderAgent
```

> 所有代理输出都必须符合约定 JSON Schema（包含 `phase/status/summary/details`），Scribe 会在出现 `REJECTED/BLOCKED` 时自动回溯到 HeadTrader。

## 核心角色与算法思路

### 研究 & 交易链路
- **DataAgent**：汇聚实时报价、成交量、波动率，确保后续角色引用的数据源一致。
- **TechAnalystAgent**：先评估 D1 趋势，再聚焦 H4 触发区间，明确关键价位、交易区间与风险位。
- **MacroAnalystAgent**：围绕实际利率、美元流动性、政策窗口构建主/备叙事，并评估与技术触发共振程度。
- **FundamentalAnalystAgent**：覆盖央行购金、ETF 流、实物溢价，补充需求/供给视角。
- **QuantResearchAgent**：调用沙盒脚本生成信号值、预期收益、风险回报与压力测试，并输出 D1 vs H4 的信号一致性。
- **HeadTraderAgent**：整合上游观点，制定基准与对冲方案。
- **PaperTraderAgent**：转换为订单、仓位调节、对冲计划，并准备交给风控。

### 风控与合规闭环
- **RiskManagerAgent**：加载最新 `risk_snapshot` 与策略计划，执行硬闸算法（见下）。
- **ComplianceAgent**：验证合规规则、文档、交易对手与审批链；如 RiskManager 的 `revision_actions` 未清理，会保持 `BLOCKED`。
- **SettlementAgent**：同步资金、保证金、交割事项，并更新 `portfolio_state`。

## 行情数据与算法路线
### Market Data Router
统一由 `services.market_data.fetch_price_history` 执行：
1. 根据请求的 symbol / interval 查询 Settings 中的 symbol map（TwelveData、Polygon 预置映射：`XAUUSD`→`XAU/USD`、`C:XAUUSD` 等）。
2. 尝试实时供应商（TwelveData、Polygon 等），使用 `requests-cache`、指数退避、UTC 时间戳归一化。
3. 回退至次级供应商（YFinance、AlphaVantage、Tanshu、Mock 数据），确保在缺口时也有序列可用。
4. 所有结果均由 `_ensure_freshness` 校验时间戳（默认 1440 分钟内有效），否则触发降级。

### 工具层集合
- `autogentest1.tools.data_tools`
  - `get_gold_market_snapshot` / `get_macro_snapshot` / `get_gold_silver_ratio` / `get_event_calendar`
  - 所有调用都回归 `fetch_price_history`，避免直连 YFinance。
- `autogentest1.tools.quant_helpers`
  - `prepare_quant_dataset`（收益、波动率、均线、RSI、ATR 等）
  - `compute_factor_exposures`（美元、股指、长债等因子暴露）
- `autogentest1.tools.portfolio`
  - 读取/更新本地组合快照，供 Settlement 维持日度记忆。
- `autogentest1.tools.rag`
  - `RagService`（Chroma 持久库） + `rag_tools.query_playbook`
  - `scripts/ingest_macro_history.py` 支持 `--namespace`、`--tag`、`--log-dir`，并写入 `outputs/ingest_logs/ingest_*.json`。

> 工具调用返回的 JSON 需包含 `source` 字段，便于审计引用来源。

## 风控硬闸算法（Risk Gate）
硬闸位于 `services.risk_gate.evaluate_plan`：
1. **输入**：纸面交易方案 JSON + 最新 `risk_snapshot`。
2. **阈值**：取自 `config.settings.Settings` 中的 `hard_gate_*` 配置，可用 `.env` 覆写。
3. **检查项**：
   - 仓位利用率 ≤ `hard_gate_max_position_utilization`
   - 单笔敞口 ≤ `hard_gate_max_single_order_oz`
   - 止损必须存在（`hard_gate_require_stop_loss`）
   - 压力情景损失 ≤ `hard_gate_max_stress_loss_millions`
   - 当日回撤 ≤ `daily_drawdown_pct`
   - 相关性阈值（组合过度集中）
4. **结果处理**：
   - 全部通过：返回 `RiskGateReport`，工作流继续。
   - 任意失败：抛出 `HardRiskBreachError`，CLI 将 `breaches` 写入磁盘并通知 Risk/HeadTrader 回炉（详见 `docs/workflows/risk_gate_flow.md`）。

## RAG 知识体系
- 向量库路径：默认 `data/rag-index`，命名空间 `gold-playbooks`。
- 语料：`data/rag/macro_history`（宏观事件）、`data/rag/trading_playbook`（交易剧本）。
- 脚本：
  ```bash
  python scripts/ingest_macro_history.py --log-dir outputs/ingest_logs
  ```
  支持 `--namespace gold-playbooks --tag macro crisis` 等参数，并生成 JSON 摘要。
- 工具调用：`rag_tools.query_playbook(question="mean reversion in gold")`。
- 测试覆盖：`tests/test_rag.py` 确保 ingest / 查询 / 回退机制。

## 市场数据供应商清单
- IBKR：申请 Metals、FX 数据订阅，启用 IB Gateway/API（详见 `docs/requirements/market_data_subscription_plan.md`）。
- Polygon.io：升级计划以获取 `Currencies`、`Indices`、`Commodities`；保存 `POLYGON_API_KEY`。
- FRED：免费注册获取 `FRED_API_KEY`，提供美元指数、TIPS 等宏观序列。
- TradingEconomics：确认配额，申请 `Client Key/Secret`，支持黄金、国债、通胀系列。
- TwelveData：可选扩展，即时行情；通过 Settings 的 `twelve_data_symbol_map` 覆写。

所有凭证放入 `.env`：
```
DEEPSEEK_API_KEY=...
POLYGON_API_KEY=...
FRED_API_KEY=...
TRADING_ECONOMICS_CLIENT=...
TRADING_ECONOMICS_SECRET=...
LOCAL_MODEL_ENABLED=false
LOCAL_MODEL_NAME=qwen2.5-14b-instruct
LOCAL_MODEL_AGENTS=DataAgent,MacroAnalystAgent,QuantResearchAgent
```

## 本地模型与未来扩展
- 支持通过 `LOCAL_MODEL_ENABLED` 将 Phase1 高频角色落到本地（例如 Qwen2.5-14B Instruct），其余仍回退 DeepSeek。
- `docs/workflows/arbitrage_agent_plan.md` 描述了金银比套利 Agent 的原型，后续版本可启用。

## 快速开始与运维
```bash
# 1. 安装依赖
pip install .

# 2. 拷贝环境变量模板并填充
cp .env.example .env

# 3. 运行主工作流（示例：回看 14 天，XAUUSD）
python -m autogentest1.main --days 14 --symbol XAUUSD

# 4. 开启新闻监听（可选）
python -m autogentest1.main --watch-news

# 5. 构建 RAG 索引并记录日志
python scripts/ingest_macro_history.py --log-dir outputs/ingest_logs

# 6. 执行全量测试
pytest
```

## 文档索引
- 风控闸门回路：`docs/workflows/risk_gate_flow.md`
- ArbitrageAgent 规划：`docs/workflows/arbitrage_agent_plan.md`
- 行情供应商清单：`docs/requirements/market_data_subscription_plan.md`
- RAG 素材 backlog：`docs/requirements/rag_corpus_backlog.md`
- 最新发布说明：`docs/releases/2025-12-04.md`

## 开发与测试
- 运行 `pytest`（42 项）验证行情、风控、RAG 等模块。
- 新增功能需确保：
  1. 工具层遵循统一行情接口；
  2. 输出遵循 JSON Schema；
  3. 更新 `.env` 配置文档与相应测试。

> 当前版本 `v0.2.0` 已通过 full test suite，详见 release notes。欢迎在 `mtr/12.4/2025-12-04-technical-prep.md` 查看每日技术准备记录。
